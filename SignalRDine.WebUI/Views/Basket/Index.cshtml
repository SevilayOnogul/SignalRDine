@model List<ResultBasketDto>
@{
    Layout = null;
    int count = 0;

    // Genel hesaplamalar döngü dışında bir kez yapılır
    decimal basketTotalPrice = Model.Sum(x => x.Price);
    decimal tax = basketTotalPrice * 0.10m;
    decimal basketTotalPriceWithTax = basketTotalPrice + tax;
}

<!DOCTYPE html>
<html>
@await Component.InvokeAsync("_UILayoutHeadComponentPartial")

<body class="sub_page">
    @await Component.InvokeAsync("_MenuNavbarComponentPartial")
    <br />
    <br />

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-12">
                <nav class="breadcrumb bg-dark mb-30 p-3 rounded-3">
                    <a class="breadcrumb-item text-white" href="/Default/Index">Ana Sayfa</a>
                    <a class="breadcrumb-item text-white" href="/Menu/Index">Menü</a>
                    <span class="breadcrumb-item active text-warning">Sepetiniz</span>
                </nav>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row px-xl-5">
            <div class="col-lg-8 table-responsive mb-5">
                <table class="table table-light table-hover text-center mb-0 shadow-sm rounded-3">
                    <thead class="thead-dark">
                        <tr>
                            <th class="py-3">#</th>
                            <th class="py-3 text-start ps-4">Ürün Adı</th>
                            <th class="py-3">Adet</th>
                            <th class="py-3">Fiyat</th>
                            <th class="py-3">Toplam</th>
                            <th class="py-3">Sil</th>
                        </tr>
                    </thead>
                    <tbody class="align-middle">
                        @foreach (var group in Model.GroupBy(x => x.ProductName))
                        {
                            var item = group.First();
                            var itemCount = group.Count();
                            decimal itemTotalPrice = item.Price * itemCount; // Sadece o satırın toplamı
                            count++;

                            <tr class="border-bottom">
                                <td class="py-3 fw-bold">@count</td>
                                <td class="text-start ps-4">@item.ProductName</td>
                                <td><span class="badge bg-secondary-subtle text-dark px-3 py-2">@itemCount</span></td>
                                <td class="text-muted">@item.Price.ToString("0.00") ₺</td>
                                <td class="fw-bold">@itemTotalPrice.ToString("0.00") ₺</td>
                                <td>
                                    <a href="/Basket/DeleteBasket/@item.BasketID" class="btn btn-sm btn-outline-danger rounded-circle">
                                        <i class="fa fa-times"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="col-lg-4">
                <h5 class="section-title position-relative text-uppercase mb-3">
                    <span class="bg-warning px-3 py-1 rounded-1 small fw-bold">Sipariş Özeti</span>
                </h5>
                <div class="card border-0 shadow-sm rounded-3">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">Toplam Tutar</span>
                            <span class="fw-semibold text-dark">@basketTotalPrice.ToString("0.00") ₺</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-muted">KDV Oranı (%10)</span>
                            <span class="text-danger fw-medium">+ @tax.ToString("0.00") ₺</span>
                        </div>
                        <hr class="my-4 border-secondary-subtle">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="mb-0 fw-bold">Genel Toplam</h5>
                            <h4 class="mb-0 text-warning fw-bold">@basketTotalPriceWithTax.ToString("0.00") ₺</h4>
                        </div>
                        <button class="btn btn-warning w-100 py-3 fw-bold shadow-sm rounded-3 text-uppercase">
                            Siparişi Tamamla
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @await Component.InvokeAsync("_UILayoutFooterComponentPartial")
    @await Component.InvokeAsync("_UILayoutScriptComponentPartial")
</body>
</html>